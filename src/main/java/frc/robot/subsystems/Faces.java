package frc.robot.subsystems;

import edu.wpi.first.wpilibj2.command.SubsystemBase;

//import edu.wpi.first.wpilibj.util.Color;

import java.io.FileReader;
//import java.io.IOException;
//import java.util.HashMap;
//import java.util.Map;
import java.util.Properties;

import edu.wpi.first.wpilibj.AddressableLED;
import edu.wpi.first.wpilibj.AddressableLEDBuffer;
import edu.wpi.first.wpilibj.Filesystem;
import edu.wpi.first.wpilibj.Timer;

public class Faces extends SubsystemBase {
    private static final int LED_PIN = 0;//port number
    private static final int NUM_LEDS = 256;//number of lights (16 by 16)
    //private static final double BRIGHTNESS = 0.5;

    private Timer time = new Timer();
    private AddressableLED led = new AddressableLED(LED_PIN);
    private AddressableLEDBuffer ledBuffer = new AddressableLEDBuffer(NUM_LEDS);

    //private static final Map<String, short[]> Face = new HashMap<String, short[]>();

    public short[] chosenFace = {  
        250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145
    };
    public short[] defaultFace = {  
        250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145,250,250,145
    };
    //private final LEDPattern blue = LEDPattern.solid(new Color(.2, .2, .2));
    public Faces() {
        //led = new AddressableLED(LED_PIN);
        led.setLength(NUM_LEDS);
        led.start();
        clear();
        //blue.applyTo(ledBuffer);
    }
    public void resetTime(){
       time.reset();
    }
    public void startTime(){
        time.start();
     }
    public double getTime(){
        return time.get();
    }

    public void clear() {
        for (int i = 0; i < NUM_LEDS; i++) {
            ledBuffer.setRGB(i, 0, 0, 0); // Turn off all LEDs
        }
        led.setData(ledBuffer);
    }
    public void makeFace(short[] pixelsArray){
        for (int i = 0, j = 0; j < NUM_LEDS && i + 2 < pixelsArray.length; i += 3, j++) {  
            ledBuffer.setRGB(j, pixelsArray[i], pixelsArray[i + 1], pixelsArray[i + 2]);
        }
        led.setData(ledBuffer);
    }
    public void setFace(short[] face){
        chosenFace = face;
    }

    public short[] getFace(String name) {
        try {
            FileReader faceFile = new FileReader(Filesystem.getDeployDirectory() + "/faces.properties");
            Properties p = new Properties();
            p.load(faceFile);
            return convertToArray(p.getProperty(name));
        } catch (Exception e) {
            System.err.println("Error loading face properties: " + e);
            return defaultFace;
        }
    }

    public short[] convertToArray(String input) {
        String[] stringArray = input.split(",");
        short[] shortArray = new short[stringArray.length];

        for (int i = 0; i < stringArray.length; i++) {
            try {
                shortArray[i] = Short.parseShort(stringArray[i].trim());
            } catch (NumberFormatException e) {
                System.err.println("Error parsing short: " + e);
                return new short[0];
            }
        }
        return shortArray;
    }

    @Override
    public void periodic() {
        //led.setData(ledBuffer);
       makeFace(chosenFace);
       //led.setData(ledBuffer);
       try {
        getFace("smile");
       } catch (Exception e) {
        // TODO: handle exception
        System.err.println(e);
       }
    }
}
